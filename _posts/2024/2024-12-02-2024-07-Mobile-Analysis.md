---
title: Mobile Analysis
author: thedead91
tags:
  - SANS Holiday Hack Challenge 2024
  - Holiday Hack Challenge
  - Holiday Hack Challenge 2024
  - Snow-maggedon

  - act2
  
  - Mobile Analysis
  - Eve Snowshoes
categories:
  - SANS Holiday Hack Challenge 2024    
  - SANS Holiday Hack Challenge 2024 - Act 2
date: 2024-12-02 07:00:00
description: Help find who has been left out of the naughty AND nice list this Christmas. Please speak with Eve Snowshoes for more information.
---

Difficulty: <span style="color:red">‚ùÑ ‚ùÑ</span> ‚ùÑ ‚ùÑ ‚ùÑ  
Help find who has been left out of the naughty AND nice list this Christmas. Please speak with Eve Snowshoes for more information.

## Hints
### Mobile Analysis Easy - Tools
*From: Eve Snowshoes*  
Try using [apktool](https://github.com/iBotPeaches/Apktool/releases) or [jadx](https://github.com/skylot/jadx)
### Mobile Analysis Easy - Missing
*From: Eve Snowshoes*  
Maybe look for what names are included and work back from that?
### Mobile Analysis Hard - Format
*From: Eve Snowshoes*  
So yeah, have you heard about this new [Android app](https://developer.android.com/guide/app-bundle/app-bundle-format) format? Want to [convert it to an APK](https://github.com/HackJJ/apk-sherlock/blob/main/aab2apk.md) file?
### Mobile Analysis Hard - Encryption and Obfuscation
*From: Eve Snowshoes*  
Obfuscated and encrypted? Hmph. Shame you can't just run [strings](https://developer.android.com/guide/topics/resources/string-resource) on the file.

## Silver trophy
For the silver trophy, I opened the [`SantaSwipe.apk`](https://www.holidayhackchallenge.com/2024/SantaSwipe.apk) with `jadx-gui`. Using that we can see the main activity (`com.northpole.santaswipe.MainActivity`) is using a DB helper to obtain a SQLite DB:
```java
protected void onCreate(Bundle savedInstanceState) {
      // ... omissis ...
      DatabaseHelper dbHelper = new DatabaseHelper(this);
      SQLiteDatabase writableDatabase = dbHelper.getWritableDatabase();
      Intrinsics.checkNotNullExpressionValue(writableDatabase, "getWritableDatabase(...)");
      this.database = writableDatabase;
      // ... omissis ...
```
Also in the method `getNormalList()` the SQL query looks off as it is excluding "Ellie":
```java
public final void getNormalList() {
    // ... omissis ...
         Cursor cursor = sQLiteDatabase.rawQuery("SELECT Item FROM NormalList WHERE Item NOT LIKE '%Ellie%'", null);
         List items = new ArrayList();
    // ... omissis ...
```
With Ellie actually being inserted in the DB by the DB Helper (`com.northpole.santaswipe.DatabaseHelper`), this is problably the kid being left out:
```java
public void onCreate(SQLiteDatabase db) {
    // ... omissis ...
    db.execSQL("INSERT INTO NormalList (Item) VALUES ('Ellie, Alabama, USA');");
    // ... omissis ...
```
And indeed "Ellie" was the solution for the Silver Trophy.

## Gold Trophy
I downloaded [`SantaSwipeSecure.aab`](https://www.holidayhackchallenge.com/2024/SantaSwipeSecure.aab) and followed the *Mobile Analysis Hard - Format* hint to convert it from the `aab` format back to an `apk`. Noticing it wasn't being executed in the emulator, I went for the signed `apk`:
```bash
(act2-Mobile Analysis) thedead@maccos SantaSwipeSecure % keytool -keystore SantaSwipeSecure.jks -genkey -alias SantaSwipeSecure -keyalg RSA
Enter keystore password:  
Re-enter new password: 
Enter the distinguished name. Provide a single dot (.) to leave a sub-component empty or press ENTER to use the default value in braces.
What is your first and last name?
  [Unknown]:  
What is the name of your organizational unit?
  [Unknown]:  
What is the name of your organization?
  [Unknown]:  
What is the name of your City or Locality?
  [Unknown]:  
What is the name of your State or Province?
  [Unknown]:  
What is the two-letter country code for this unit?
  [Unknown]:  
Is CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct?
  [no]:  yes

Generating 3,072 bit RSA key pair and self-signed certificate (SHA384withRSA) with a validity of 90 days
    for: CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown

(act2-Mobile Analysis) thedead@maccos SantaSwipeSecure % bundletool build-apks --bundle=SantaSwipeSecure.aab --output=SantaSwipeSecure.apks --mode=universal --ks=SantaSwipeSecure.jks --ks-key-alias=SantaSwipeSecure --ks-pass=pass:password

(act2-Mobile Analysis) thedead@maccos SantaSwipeSecure % cp SantaSwipeSecure.apks SantaSwipeSecure.zip
```
Finally I was able to run `universal.apk` in an emulator and observe its contents with `jadx-gui`. As per the hints, it turned out to be encrypted, therefore exploring the files used in the Silver trophy only led to an encrypted string and to the `decryptData` method in `com.northpole.santaswipe.DatabaseHelper`:
```java
public void onCreate(SQLiteDatabase db) {
    Intrinsics.checkNotNullParameter(db, "db");
    db.execSQL("CREATE TABLE IF NOT EXISTS NiceList (Item TEXT);");
    db.execSQL("CREATE TABLE IF NOT EXISTS NaughtyList (Item TEXT);");
    db.execSQL("CREATE TABLE IF NOT EXISTS NormalList (Item TEXT);");
    db.execSQL(decryptData("IVrt+9Zct4oUePZeQqFwyhBix8cSCIxtsa+lJZkMNpNFBgoHeJlwp73l2oyEh1Y6AfqnfH7gcU9Yfov6u70cUA2/OwcxVt7Ubdn0UD2kImNsclEQ9M8PpnevBX3mXlW2QnH8+Q+SC7JaMUc9CIvxB2HYQG2JujQf6skpVaPAKGxfLqDj+2UyTAVLoeUlQjc18swZVtTQO7Zwe6sTCYlrw7GpFXCAuI6Ex29gfeVIeB7pK7M4kZGy3OIaFxfTdevCoTMwkoPvJuRupA6ybp36vmLLMXaAWsrDHRUbKfE6UKvGoC9d5vqmKeIO9elASuagxjBJ"));
    insertInitialData(db);
    }
```
```java
private final String decryptData(String encryptedData) {
    try {
        Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
        cipher.init(2, this.secretKeySpec, new GCMParameterSpec(128, this.iv));
        byte[] doFinal = cipher.doFinal(Base64.decode(encryptedData, 0));
        Intrinsics.checkNotNull(doFinal);
        return new String(doFinal, Charsets.UTF_8);
    } catch (Exception e) {
        Log.e("DatabaseHelper", "Decryption failed: " + e.getMessage());
        return null;
    }
}
```
At that point I resorted to [`frida`](https://github.com/frida/frida) and [`RMS`](https://github.com/m0bilesecurity/RMS-Runtime-Mobile-Security) aiming to hook the `decryptData` method and decrypt the string:
```bash
thedead@maccos act2-Mobile Analysis % adb -s 127.0.0.1:6555 push frida-server-16.5.7-android-arm64 /tmp/frida-server
frida-server-16.5.7-android-arm64: 1 f... 251.9 MB/s (56549216 bytes in 0.214s)
genymotion:/# chmod +x /tmp/frida-server                                                                            
genymotion:/# ./tmp/frida-server              
```
I set up everything in `RMS`:  
![07_01_MobileAnalysis_rms_01.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_01_MobileAnalysis_rms_01.png)  
![07_02_MobileAnalysis_rms_02.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_02_MobileAnalysis_rms_02.png)  

I then used `Heap Search` to manually call the `decryptData` method with the encrypted string seen above:
![07_03_MobileAnalysis_rms_03.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_03_MobileAnalysis_rms_03.png)  
![07_04_MobileAnalysis_rms_04.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_04_MobileAnalysis_rms_04.png)  
Decrypting the content resulted in the following SQL:
```sql
CREATE TRIGGER DeleteIfInsertedSpecificValue
    AFTER INSERT ON NormalList
    FOR EACH ROW
    BEGIN
        DELETE FROM NormalList WHERE Item = 'KGfb0vd4u/4EWMN0bp035hRjjpMiL4NQurjgHIQHNaRaDnIYbKQ9JusGaa1aAkGEVV8=';
    END;
```
Finally, calling the `decryptData` method on this last string returned the answer to the challenge:
![07_05_MobileAnalysis_rms_05.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_05_MobileAnalysis_rms_05.png)
Showing that the kid being left out was poor `Joshua, Birmingham, United Kingdom`, with the flag being just the name `Joshua`. 

## Special Thanks
### Thanks to [@m0bilesecurity](https://github.com/m0bilesecurity)
I am not an expert on mobile security tools and he had the patience to help me through the real challenge which was the setup of the environment üòä  
Once setup, his [RMS](https://github.com/m0bilesecurity/RMS-Runtime-Mobile-Security) basically made everything very easy.
#### Showcasing RMS
Just a quick video to showcase how RMS allowed all of this to be done in less than a minute :)
<iframe width="100%" height="315" src="https://www.youtube.com/embed/qiONt-3zzU4?si=ZV12y2A9ci8cOWfg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Everything that went wrong
I don't know if it will be useful for others, but it'll defintely be for me, so I better keep here notes on what went wrong during the process so if I'll ever need it again I'll save myself some headache.

### Android Studio Emulator
The first place I looked for an emulator was [Android Studio](https://developer.android.com/studio), but I was not able to setup [`frida`](https://github.com/frida/frida) on it.
I had to root the emulated device using [rootAVD](https://gitlab.com/newbit/rootAVD) and succeded it follwing these [instructions](https://xdaforums.com/t/script-rootavd-root-your-android-studio-virtual-device-emulator-with-magisk-android-linux-darwin-macos-win-google-play-store-apis.4218123/#google_vignette).
Despite the rooting, I still had the error `adbd cannot run as root in production builds` but I was able to get root once in the shell with `su`.
[Frida instructions for Android](https://frida.re/docs/android/) accounts for this issue but I still got the following error when running `frida-server`:
![07_06_MobileAnalysis_FridaServer.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_06_MobileAnalysis_FridaServer.png)
[I didn't look like the only one with this problem](https://github.com/frida/frida/issues/2954) but still I wasn't able to solve it.

### Genymotion
Once I gave up on the Android Studio Emulator, I went for [Genymotion](https://www.genymotion.com/), as [@m0bilesecurity](https://github.com/m0bilesecurity) suggested it should provide pre-rooted devices. It took me some clicking around to actually find such "free" pre-rooted device:
![07_07_MobileAnalysis_Genymotion.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_07_MobileAnalysis_Genymotion.png)

### node version
When trying to install [RMS](https://github.com/m0bilesecurity/RMS-Runtime-Mobile-Security) I encountered the error `No prebuilt binary`
![07_08_MobileAnalysis_NoPrebuiltBinaries.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_08_MobileAnalysis_NoPrebuiltBinaries.png)
As pointed out by [@m0bilesecurity](https://github.com/m0bilesecurity) that was an issue with my `node` version as `frida` does not have the prebuilt binaries for `node.js v23.3.0`.
I resorted to [`nvm`](https://github.com/nvm-sh/nvm) to fix the version in the working folder to `v22.11.0`. Still I obviously got another error:
![07_09_MobileAnalysis_nvmError.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_09_MobileAnalysis_nvmError.png)
Not sure what the issue was as when I ran it again the day after it worked first shot:
![07_10_MobileAnalysis_mac_rmsStart.png](/assets/img/posts/2024/2024-07-Mobile-Analysis/07_10_MobileAnalysis_mac_rmsStart.png)

### arm64
Giving up on the local installation I restorted to a [`kali`](https://www.kali.org/) vm that already had node `v20.18.0` and the installation there was as easy as:
```bash
pip3 install frida-tools --break-system-packages
npm install -g rms-runtime-mobile-security
```
On the other hand I am using a Macbook with Apple M3 cpu (or at least I'm trying to üòä) which is an `arm64`, thus my `kali` is a `linux arm64` as well. Not that I crazily searched for it, but I didn't find a version for such OS & architecture for Android Studio and Genymotion.

### Port forwarding `adb`
The obvious idea was to run the emulated device and the `adb` server on the host, while using `adb`, `frida` and `rms` in the VM. To allow this setup to work I just had to forward the port of the `adb` using `ssh`:
```bash
thedead@maccos RMS-Runtime-Mobile-Security % ssh -R 5037:localhost:5037 root@192.168.180.129
‚îå‚îÄ‚îÄ(root„âømac-vikali)-[~]
‚îî‚îÄ# adb devices
List of devices attached
127.0.0.1:6555  device

‚îå‚îÄ‚îÄ(root„âømac-vikali)-[~]
‚îî‚îÄ# adb -s 127.0.0.1:6555 shell
genymotion:/# whoami
root
```
